<!DOCTYPE html>
<html lang="ja">

<head>

  <meta charset="UTF-8">
  <!--[if IE]>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <![endif]-->
  <meta name="viewport" content="target-densitydpi=device-dpi, width=980, maximum-scale=1.0, user-scalable=yes">
  <meta name="description" content="DESCRIPTION">
  <meta name="keywords" content="KEYWORDS">
  <meta name="author" content="Seino">

  <title>TITLE</title>

  <link rel="stylesheet" href="css/common.css" media='all'>
  <!--[if lt IE 9]>
    <script src="javascripts/html5shiv.min.js"></script>
  <![endif]-->
  <script src="js/lib/jquery.min.js"></script>
  <script src="js/lib/fabric.min.js"></script>
  <link rel="shortcut icon" href="">
  <!--
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" sizes="196x196" href="">
    <link rel="apple-touch-icon" sizes="152x152" href="">
  -->

</head>

<body id="index">

  <div class="container">

    <header class="header clearfix" id="page-top">
      <h1>

      </h1>
    </header>

    <div class="contents">
      <main class="content-main">
      </main><!--/content-main-->
    </div><!--/contents-->

  </div>
  <!--/container-->

</body>
<script>
  // (function(){
    var canvasWidth = window.innerWidth;
        $canvas = $('<canvas id="demoCanvas" class="main-canvas" width="' + canvasWidth + '" height="600"></canvas>').appendTo('main'),
        canvas = new fabric.Canvas($canvas[0]),
        defaultOptions = {
          left: 100,
          top: 100,
          fill: '#f7e6ce',
          width: 200,
          height: 200,
          shadow: {
            color: 'rgba(0, 0, 0, 0.3)',
            blur: 1,
            offsetX: 1,
            offsetY: 1
          }
        };

    //デフォルト選択スタイル設定
    $.extend( fabric.Object.prototype, {
      borderColor: 'rgba(0, 100, 255, 0.3)',
      cornerColor: 'rgba(0, 100, 255, 0.3)',
      cornerSize: 8,
      transparentCorners: false,
      padding: 5,
    });

    function animate(e, dir, callback) {
      if (e.target) {
        fabric.util.animate({
          startValue: e.target.get('scaleX'),
          endValue: e.target.get('scaleX') + (dir ? 0.02 : -0.02),
          duration: 50,
          onChange: function(value) {
            e.target.scale(value);
            canvas.renderAll();
          },
          onComplete: function() {
            e.target.setCoords();
            if(callback) callback(e);
          }
        });
      }
    }

    var mouseDowned = { state: false, target: null },
        selectionCleared = { state: false, target: null };

    canvas.on('object:selected', function(e) {
      console.log('object:selected');
      console.log(e);
    });

    canvas.on('selection:cleared', function(e) {
      console.log('selection:cleared');
      selectionCleared = { state: true, target: e.target };
      console.log(e);
    });

    canvas.on('mouse:down', function(e) {
      console.log('mouse:down');
      mouseDowned = { state: true, target: e.target };
      console.log(e)
    });

    canvas.on('mouse:move', function(e) {
      mouseDowned = { state: false, target: null };
      selectionCleared = { state: false, target: null };
    });

    canvas.on('mouse:up', function(e) {
      console.log('mouse:up');
      if( mouseDowned.state ) {
        if( !mouseDowned.target ) {
          //直前に選択状態が解除された場合は作らない
          if( selectionCleared.state ) {
            selectionCleared = { state: false, target: null };
            return;
          }

          mouse_start_pos = canvas.getPointer(e.e);
          // 矩形オブジェクトを作る
          var rect = new fabric.Rect($.extend(defaultOptions, {
            left: mouse_start_pos.x - defaultOptions.width / 2,
            top: mouse_start_pos.y - defaultOptions.height / 2
          }));
          // canvas 上に矩形を追加する
          canvas.add(rect);
        } else {
          canvas.trigger('mouse:click', e);
        }
      }
      selectionCleared = { state: false, target: null };
      console.log(e)
    });

    canvas.on('mouse:click', function(e) {
      console.log('mouse:click');
      console.log(e);
      animate(e, 1, function(e){ animate(e, 0); });
    });


    // canvas.selectionColor = 'rgba(255,0,0,1)';
    // canvas.selectionBorderColor = 'blue';
    // canvas.selectionLineWidth = 5;

    console.log(canvas);
  // })();
</script>

</html>
